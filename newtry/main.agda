{-# OPTIONS --type-in-type #-}

module main where

open import Function
open import Data.Unit
open import Data.Product
open import Data.Nat
-- open import Data.Sum
open import prop
open import freeSetoid
open import univ

open graphOver

-- Contexts, types, instances
data Context : Set
Type : Context â†’ Set
âŸ¦_âŸ§C : Context â†’ Set
=C : âˆ€ (Î“ : Context) â†’ Set
sC : âˆ€ {Î“ : Context} â†’ =C Î“ â†’ âŸ¦ Î“ âŸ§C
tC : âˆ€ {Î“ : Context} â†’ =C Î“ â†’ âŸ¦ Î“ âŸ§C

-- A context is either empty, or the extension of Î“ by a Î“-type
data Context where
  âŸ¨âŸ© : Context  -- this is now \<\>
  _,,_ : âˆ€ Î“ â†’ (Type Î“) â†’ Context

-- A Î“-type is a family of elts of U indexed by Î“-instances
Type Î“ = Î£[ A âˆˆ (âŸ¦ Î“ âŸ§C â†’ U) ] (âˆ€ (e : =C Î“) â†’ Eq (A (sC e)) (A (tC e)))

-- An instance of Î“ is a tuple of elts of corresponding types
âŸ¦ âŸ¨âŸ© âŸ§C = âŠ¤
âŸ¦ Î“ ,, A âŸ§C = Î£[ Î³ âˆˆ âŸ¦ Î“ âŸ§C ] T (projâ‚ A Î³)
infixl 70 _,,_

-- The elements of a Î“-type on the metalevel
âŸ¦_âŸ§T : âˆ€ {Î“} â†’ Type Î“ â†’ Set
âŸ¦_âŸ§T {Î“} A = âˆ€ (Î³ : âŸ¦ Î“ âŸ§C) â†’ T (projâ‚ A Î³)
EltT : âˆ€ {Î“} â†’ Type Î“ â†’ âŸ¦ Î“ âŸ§C â†’ Set
EltT A = T âˆ˜ (projâ‚ A)

-- The free setoid structure on contexts
=C âŸ¨âŸ© = âŠ¤
=C (Î“ ,, A) = Î£[ Î³* âˆˆ (=C Î“) ] (
                 Î£[ aâ‚aâ‚‚ âˆˆ (EltT A (sC Î³*) Ã— EltT A (tC Î³*)) ]
                   (projâ‚ aâ‚aâ‚‚ âˆ¼âŸ¨ projâ‚‚ A Î³* âŸ© projâ‚‚ aâ‚aâ‚‚))
sC {âŸ¨âŸ©} _ = tt
sC {Î“ ,, A} (Î³* , ((a1 , a2) , a*)) = sC Î³* , a1
tC {âŸ¨âŸ©} _ = tt
tC {Î“ ,, A} (Î³* , ((a1 , a2) , a*)) = tC Î³* , a2

âŸ¦_âŸ§C' : âˆ€ (Î“ : Context) â†’ graphOver âŸ¦ Î“ âŸ§C
âŸ¦ Î“ âŸ§C' = makeGraph (=C Î“) sC tC


-- The setoid structure on (interpretation of) types
-- Type' : âˆ€ (Î“ : Context) (A : Type Î“) â†’ isFibS âŸ¦ Î“ âŸ§C' (EltT A)
-- Type' Î“ A = makeFibS {!!} {!!} {!!}

{-
-- âŸ¦_âŸ§T' : âˆ€ {Î“} (A : Type Î“) (Î³ : âŸ¦ Î“ âŸ§C) â†’ isSetoid (âŸ¦ A âŸ§T Î³)
T' ğŸ˜ = ğŸ˜:Set
T' ğŸ™ = ğŸ™:Set
T' Î© = Prop:Set
T' (Ï€ A B) = {!!}
T' (Ïƒ A B) = {!!}
T' (A â‰ƒ B) = {!!} -}

data Var : âˆ€ (Î“ : Context) (A : Type Î“) â†’ Set where
  âŠ¥ : âˆ€ {Î“} {A} â†’ Var (Î“ ,, A) (projâ‚ A âˆ˜ projâ‚ , projâ‚‚ A âˆ˜ projâ‚)
  â†‘ : âˆ€ {Î“} {A} {B} â†’ Var Î“ B â†’ Var (Î“ ,, A) (projâ‚ B âˆ˜ projâ‚ , projâ‚‚ B âˆ˜ projâ‚)

-- Projection functions: âŸ¦Î“âŸ§ â†’ âŸ¦Aáµ¢âŸ§, given index (xáµ¢ : Aáµ¢) âˆˆ Î“
âŸ¦_âŸ§V : âˆ€ {Î“} {A} â†’ Var Î“ A â†’ âŸ¦ A âŸ§T
âŸ¦ âŠ¥ âŸ§V (_ , a) = a
âŸ¦ â†‘ x âŸ§V (Î³ , _) = âŸ¦ x âŸ§V Î³

Telescope : â„• â†’ Set
Telescope zero = U
Telescope (suc n) = Î£[ A âˆˆ U ] (T A â†’ Telescope n)

cons : âˆ€ {n} (A : U) â†’ (T A â†’ Telescope n) â†’ Telescope (suc n)
cons A B = A , B

syntax cons A (Î» a â†’ B) = a âˆ¶ A â‡’ B

tjt : âˆ€ {n} Î“ â†’ (âŸ¦ Î“ âŸ§C â†’ Telescope n) â†’ Set -- "Typing judgement with telescope"
data tj (Î“ : Context) : Type Î“ â†’ Set
infix 75 âŸ¦_âŸ§
âŸ¦_âŸ§ : âˆ€ {Î“} {A} â†’ tj Î“ A â†’ âŸ¦ A âŸ§T

tjt {zero} Î“ A = tj Î“ A
tjt {suc n} Î“ P = tjt {n} (Î“ ,, (Î» Î³ â†’ projâ‚ (P Î³))) (Î» Î³ â†’ projâ‚‚ (P (projâ‚ Î³)) (projâ‚‚ Î³))

syntax tjt Î“ (Î» Î³ â†’ A) = Î³ âˆ¶ Î“ âŠ¢ A

data tj Î“ where -- "Typing judgement"
  ğ”± : 
    -------------
      Î³ âˆ¶ Î“ âŠ¢ ğŸ™

  TT : 
    -------------
      Î³ âˆ¶ Î“ âŠ¢ Î©

  FF : 
    -------------
      Î³ âˆ¶ Î“ âŠ¢ Î©

  var : âˆ€ {A} â†’ 
      Var Î“ A â†’ 
    ---------------
      Î³ âˆ¶ Î“ âŠ¢ A Î³

  âˆ¼     : âˆ€ 
      {A : Î³ âˆ¶ Î“ âŠ¢ *}   {B : Î³ âˆ¶ Î“ âŠ¢ *} â†’ (Î³ âˆ¶ Î“ âŠ¢ âŸ¦ A âŸ§ Î³ â‰ƒ âŸ¦ B âŸ§ Î³) â†’
    -------------------------------------------------------------------
                    Î³ âˆ¶ Î“ âŠ¢ âŸ¦ A âŸ§ Î³ â†’ Î³ âˆ¶ Î“ âŠ¢ âŸ¦ B âŸ§ Î³ â†’ Î³ âˆ¶ Î“ âŠ¢ *

  Î›     : âˆ€ 
      {A : Î³ âˆ¶ Î“ âŠ¢ *}    {B : Î³ âˆ¶ Î“ âŠ¢ (a âˆ¶ âŸ¦ A âŸ§ Î³ â‡’ *)} â†’  Î³ âˆ¶ Î“ âŠ¢ (a âˆ¶ âŸ¦ A âŸ§ Î³ â‡’ âŸ¦ B âŸ§ (Î³ , a)) â†’ 
    ------------------------------------------------------------------------------------------------
                     Î³ âˆ¶ Î“ âŠ¢ Ï€[ a âˆ¶ âŸ¦ A âŸ§ Î³ ] âŸ¦ B âŸ§ (Î³ , a)

  app   : âˆ€ 
      {A : Î³ âˆ¶ Î“ âŠ¢ *}   {B : Î³ âˆ¶ Î“ âŠ¢ (a âˆ¶ âŸ¦ A âŸ§ Î³ â‡’ *)} â†’   Î³ âˆ¶ Î“ âŠ¢ Ï€[ a âˆ¶ âŸ¦ A âŸ§ Î³ ] âŸ¦ B âŸ§ (Î³ , a) â†’      âˆ€ (a : Î³ âˆ¶ Î“ âŠ¢ âŸ¦ A âŸ§ Î³) â†’
    ---------------------------------------------------------------------------------------------------------------------------------
                                     Î³ âˆ¶ Î“ âŠ¢ âŸ¦ B âŸ§ (Î³ , (âŸ¦ a âŸ§ Î³))

  pair  : âˆ€ 
      {A : Î³ âˆ¶ Î“ âŠ¢ *}   {B : Î³ âˆ¶ Î“ âŠ¢ (a âˆ¶ âŸ¦ A âŸ§ Î³ â‡’ *)}     (a : Î³ âˆ¶ Î“ âŠ¢ âŸ¦ A âŸ§ Î³) â†’    Î³ âˆ¶ Î“ âŠ¢ âŸ¦ B âŸ§ (Î³ , âŸ¦ a âŸ§ Î³) â†’
    -------------------------------------------------------------------------------------------------------------------
                                   Î³ âˆ¶ Î“ âŠ¢ Ïƒ[ a âˆ¶ âŸ¦ A âŸ§ Î³ ] âŸ¦ B âŸ§ (Î³ , a)

  Ï€â‚    : âˆ€ 
      {A : Î³ âˆ¶ Î“ âŠ¢ *}     {B : Î³ âˆ¶ Î“ âŠ¢ (a âˆ¶ âŸ¦ A âŸ§ Î³ â‡’ *)} â†’      Î³ âˆ¶ Î“ âŠ¢ Ïƒ[ a âˆ¶ âŸ¦ A âŸ§ Î³ ] âŸ¦ B âŸ§ (Î³ , a) â†’
    ----------------------------------------------------------------------------------------------------------
                                        Î³ âˆ¶ Î“ âŠ¢ âŸ¦ A âŸ§ Î³

  Ï€â‚‚    : âˆ€ 
      {A : Î³ âˆ¶ Î“ âŠ¢ *}        {B : Î³ âˆ¶ Î“ âŠ¢ (a âˆ¶ âŸ¦ A âŸ§ Î³ â‡’ *)}     (p : Î³ âˆ¶ Î“ âŠ¢ Ïƒ[ a âˆ¶ âŸ¦ A âŸ§ Î³ ] âŸ¦ B âŸ§ (Î³ , a)) â†’ 
    ---------------------------------------------------------------------------------------------------------------
                      Î³ âˆ¶ Î“ âŠ¢ âŸ¦ B âŸ§ (Î³ , (projâ‚ (âŸ¦ p âŸ§ Î³)))

  **    : 
    -----------------
      Î³ âˆ¶ Î“ âŠ¢ * â‰ƒ *

  pistar : âˆ€ 
      {A  : Î³ âˆ¶ Î“ âŠ¢ *}                                         {B : Î³ âˆ¶ Î“ âŠ¢ (a âˆ¶ âŸ¦ A âŸ§ Î³ â‡’ *)}
      {A' : Î³ âˆ¶ Î“ âŠ¢ *}                                         {B' : Î³ âˆ¶ Î“ âŠ¢ (a âˆ¶ âŸ¦ A' âŸ§ Î³ â‡’ *)}
      (A* : Î³ âˆ¶ Î“ âŠ¢ âŸ¦ A âŸ§ Î³ â‰ƒ âŸ¦ A' âŸ§ Î³) â†’    (Î³ âˆ¶ Î“ âŠ¢ (a âˆ¶ âŸ¦ A âŸ§ Î³ â‡’ (a' âˆ¶ âŸ¦ A' âŸ§ Î³ â‡’ (a* âˆ¶ a âˆ¼âŒ© âŸ¦ A* âŸ§ Î³ âŒª a' â‡’ âŸ¦ B âŸ§ (Î³ , a) â‰ƒ âŸ¦ B' âŸ§ (Î³ , a'))))) â†’
    ---------------------------------------------------------------------------------------------------------------------------------------------------------------
                                  Î³ âˆ¶ Î“ âŠ¢ (Ï€[ a âˆ¶ âŸ¦ A âŸ§ Î³ ] âŸ¦ B âŸ§ (Î³ , a)) â‰ƒ (Ï€[ a' âˆ¶ âŸ¦ A' âŸ§ Î³ ] âŸ¦ B' âŸ§ (Î³ , a'))

  sigmastar : âˆ€ 
      {A  : Î³ âˆ¶ Î“ âŠ¢ *}                                         {B : Î³ âˆ¶ Î“ âŠ¢ (a âˆ¶ âŸ¦ A âŸ§ Î³ â‡’ *)}
      {A' : Î³ âˆ¶ Î“ âŠ¢ *}                                         {B' : Î³ âˆ¶ Î“ âŠ¢ (a âˆ¶ âŸ¦ A' âŸ§ Î³ â‡’ *)}
      (A* : Î³ âˆ¶ Î“ âŠ¢ âŸ¦ A âŸ§ Î³ â‰ƒ âŸ¦ A' âŸ§ Î³) â†’    (Î³ âˆ¶ Î“ âŠ¢ (a âˆ¶ âŸ¦ A âŸ§ Î³ â‡’ (a' âˆ¶ âŸ¦ A' âŸ§ Î³ â‡’ (a* âˆ¶ a âˆ¼âŒ© âŸ¦ A* âŸ§ Î³ âŒª a' â‡’ âŸ¦ B âŸ§ (Î³ , a) â‰ƒ âŸ¦ B' âŸ§ (Î³ , a'))))) â†’
    ---------------------------------------------------------------------------------------------------------------------------------------------------------------
                                  Î³ âˆ¶ Î“ âŠ¢ (Ïƒ[ a âˆ¶ âŸ¦ A âŸ§ Î³ ] âŸ¦ B âŸ§ (Î³ , a)) â‰ƒ (Ïƒ[ a' âˆ¶ âŸ¦ A' âŸ§ Î³ ] âŸ¦ B' âŸ§ (Î³ , a'))

  eqstar : âˆ€ 
      {A : Î³ âˆ¶ Î“ âŠ¢ *}                   {B : Î³ âˆ¶ Î“ âŠ¢ *}
      {A' : Î³ âˆ¶ Î“ âŠ¢ *}                  {B' : Î³ âˆ¶ Î“ âŠ¢ *} â†’
      (Î³ âˆ¶ Î“ âŠ¢ âŸ¦ A âŸ§ Î³ â‰ƒ âŸ¦ A' âŸ§ Î³) â†’    (Î³ âˆ¶ Î“ âŠ¢ âŸ¦ B âŸ§ Î³ â‰ƒ âŸ¦ B' âŸ§ Î³) â†’
    ----------------------------------------------------------------------
              Î³ âˆ¶ Î“ âŠ¢ (âŸ¦ A âŸ§ Î³ â‰ƒ âŸ¦ B âŸ§ Î³) â‰ƒ (âŸ¦ A' âŸ§ Î³ â‰ƒ âŸ¦ B' âŸ§ Î³)

âŸ¦ ğ”± âŸ§                 = unit
âŸ¦ TT âŸ§                = âŠ¤
âŸ¦ FF âŸ§                = âŠ¥
âŸ¦ var x âŸ§ Î³           = âŸ¦ x âŸ§V Î³
âŸ¦ âˆ¼ e a b âŸ§ Î³         = âŸ¦ a âŸ§ Î³ âˆ¼âŒ© âŸ¦ e âŸ§ Î³ âŒª âŸ¦ b âŸ§ Î³
âŸ¦ Î› M âŸ§ Î³             = Î» a â†’ âŸ¦ M âŸ§ (Î³ , a)
âŸ¦ app M N âŸ§ Î³         = âŸ¦ M âŸ§ Î³ (âŸ¦ N âŸ§ Î³)
âŸ¦ pair a b âŸ§ Î³        = (âŸ¦ a âŸ§ Î³) , (âŸ¦ b âŸ§ Î³)
âŸ¦ Ï€â‚ p âŸ§ Î³            = projâ‚ (âŸ¦ p âŸ§ Î³)
âŸ¦ Ï€â‚‚ p âŸ§ Î³            = projâ‚‚ (âŸ¦ p âŸ§ Î³)
âŸ¦ ** âŸ§ Î³              = r*
âŸ¦ pistar A* B* âŸ§ Î³    = Ï€* (âŸ¦ A* âŸ§ Î³) (Î» a a' a* â†’ âŸ¦ B* âŸ§ (((Î³ , a) , a') , a*))
âŸ¦ sigmastar A* B* âŸ§ Î³ = Ïƒ* (âŸ¦ A* âŸ§ Î³) (Î» a a' a* â†’ âŸ¦ B* âŸ§ (((Î³ , a) , a') , a*))
âŸ¦ eqstar A* B* âŸ§ Î³    = âŸ¦ A* âŸ§ Î³ â‰ƒ* âŸ¦ B* âŸ§ Î³

postulate Î“ : Context
postulate A : Î³ âˆ¶ Î“ âŠ¢ *
postulate B : Î³ âˆ¶ Î“ âŠ¢ (a âˆ¶ âŸ¦ A âŸ§ Î³ â‡’ *)
postulate M : Î³ âˆ¶ Î“ âŠ¢ (a âˆ¶ âŸ¦ A âŸ§ Î³ â‡’ âŸ¦ B âŸ§ ( Î³ , a ))
postulate N : Î³ âˆ¶ Î“ âŠ¢ âŸ¦ A âŸ§ Î³
postulate g : âŸ¦ Î“ âŸ§C
postulate P : T (âŸ¦ B âŸ§ (g , âŸ¦ N âŸ§ g)) â†’ Set
postulate x : P (âŸ¦ app {A = A} {B} (Î› {A = A} {B} M) N âŸ§ g)
y : P (âŸ¦ M âŸ§ (g , âŸ¦ N âŸ§ g))
y = x
  
